close all;
for looping =1:4
   % clear x frames;
   clearvars -except looping;
clc;
filePath='/Users/dinhgiabao/Desktop/HK1-nam3/XLTinHieu/endcourse/TinHieuHuanLuyen/';
files = { '02FVA', '03MAB', '06FTB','01MDA'};
name = char(strcat(filePath, files(looping), '.wav'));

%0 si 1 speech

FVA=[0 0,0.83 1,1.37 0,2.09 1,2.60 0,3.57 1,4.00 0,4.76 1,5.33 0,6.18 1,6.68 0,7.18 1];
MAB =[0 0,1.03 1,1.42 0,2.46 1,2.80 0,4.21 1,4.52 0,6.81 1,7.14 0,8.22 1,8.50 0,9.37 1];
FTB = [0 0,1.52 1,1.92 0,3.91 1,4.35 0,6.18 1,6.6 0,8.67 1,9.14 0,10.94 1,11.33 0,12.75 1];
MDA = [0 0,0.45 1,0.81 0,1.53 1,1.85 0,2.69 1,2.86 0,3.78 1,4.15 0,4.84 1,5.14 0,5.58 1];

if (imlooping==1)
    standardVals=FVA;
elseif (imlooping==2)
    standardVals=MAB;
elseif (imlooping==3)
    standardVals=FTB;
elseif (imlooping==4)
    standardVals=MDA;
end;




    [x,t1,fs]=normalizedAmplitude(name);

    time_duration=0.03; %do dai moi khung 
    lag = 0.01; %do tre moi khung
    pdlow=1/450; pdhigh=1/70; 
    %gioi han tan so F0 trong khoang 70hz->450hz->giam do phuc tap

    n_min = floor(pdlow*fs);
    n_max = floor(pdhigh*fs);

    lenX = length(x) ;%do dai tin hieu vao theo mau
    nSampleFrame = time_duration*fs; %do dai 1 frame tinh theo mau
    nSampleLag = lag*fs; %do dai do dich cua frame theo mau

    
    nFrame= int32(lenX-nSampleFrame)/nSampleLag+1; %so frame chia duoc
    t=(1:nFrame)*fs/nSampleLag; 
   
    
%     ZCRarr=zeros(1,nFrame);
    STEarr=zeros(1,nFrame);
    MAarr= zeros(1,nFrame);
    VUframe = zeros(1,nFrame);
    VUindex =[];
   
    
    %chia frame
    for frame_index=1:nFrame
        a=(frame_index-1)*nSampleLag+1;
        b=(frame_index-1)*nSampleLag+nSampleFrame+1;
        if b <= lenX
            frame= x(a:b); %xac dinh 1 frame
        else 
            frame= x(a:lenX);
            frame(lenX:b)=0;
        end
        
%         ZCR computing
%         zcr=0;
%         for  i = 2:nSampleFrame
%             if frame(i)*frame(i-1) <0
%                 zcr=zcr+1;
%             end
%         end
%         ZCRarr(frame_index)=zcr;
       
        %MA computing
        MAarr(frame_index)= sum(abs(frame));
        
        %STE computing
        STEarr(frame_index)=sum(frame.^2);   
    end
         
  
     %ZCRarr= (ZCRarr - min(ZCRarr))/(max(ZCRarr) - min(ZCRarr));
    MAarr= MAarr./max(MAarr);
    STEarr=STEarr./max(STEarr);
    
    %define Speech-Silence
    for frame_index=1:nFrame
       if MAarr(frame_index)>0.35 || STEarr(frame_index) >0.018
           frame_index
           VUframe(frame_index)=1;
       end
    end
    
        for frame_index=2:nFrame-1
          if VUframe(frame_index) ~= VUframe(frame_index-1) && VUframe(frame_index) == VUframe(frame_index+1)
               index = double(double(frame_index-1)*0.03-double((frame_index-2))*0.01);
               if(index < t1(length(t1)))
                    VUindex=[VUindex index];
               end
          end
        end
       
    figure;
    subplot(2,1,1); plot(t,STEarr,'g','LineWidth',2);
    hold on;
    plot(t,MAarr,'r','LineWidth',2);
    hold on;
    title('Short-time energy(STE) vs MA');
    xlabel('Time axis');
    legend('Short-time energy', 'MA');

    subplot(2,1,2);plot(t1,x);
    hold on;
     for i=1:length(VUindex)
            plot([1 1]*double(VUindex(i)), ylim, 'r','LineWidth', 2);
     end
     hole on;
     len=length(standardVals);
     for i=1:len
     if(standardVals(i,2)==1)
        line([temporary temporary],[-1 1],'Color',[.8 .0 .0]);
     end;
    if(standardVals(i,2)==2)
        line([temporary temporary],[-1 1],'Color',[.0 .8 .0]);
    end;
      end;
     
     
    title('Speech Signal');
    xlabel('Time axis');
    ylabel('normalizedAmplitude');
end

